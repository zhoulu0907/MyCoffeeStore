# MyCoffeeStore 后端测试计划

> **文档版本**: v1.0
> **创建时间**: 2026-02-26
> **测试负责人**: 测试工程师

---

## 1. 测试概述

### 1.1 后端技术栈

```
框架: Spring Boot 3.x
JDK: Java 17
ORM: MyBatis-Flex
构建工具: Maven
数据库: MySQL 8.0
测试框架: JUnit 5 + Mockito
```

### 1.2 测试分层

```
┌─────────────────────────────────────┐
│     API 集成测试 (Integration)      │
├─────────────────────────────────────┤
│      Service 单元测试 (Unit)        │
├─────────────────────────────────────┤
│      Mapper 数据访问测试 (DAO)       │
└─────────────────────────────────────┘
```

---

## 2. 单元测试计划

### 2.1 JUnit 5 配置

```xml
<!-- pom.xml -->
<dependencies>
    <!-- JUnit 5 -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- Mockito -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- Spring Boot Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- H2 内存数据库 -->
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 2.2 Service 层单元测试

#### 2.2.1 UserService 测试

```java
@SpringBootTest
class UserServiceTest {

    @Mock
    private UserMapper userMapper;

    @InjectMocks
    private UserService userService;

    private User testUser;

    @BeforeEach
    void setUp() {
        testUser = new User();
        testUser.setId(1L);
        testUser.setUsername("testuser");
        testUser.setEmail("test@example.com");
        testUser.setPassword("$2a$10$encodedPassword");
    }

    @Test
    @DisplayName("用户注册成功 - 邮箱未注册")
    void register_Success_EmailNotExists() {
        // Given
        RegisterRequest request = new RegisterRequest();
        request.setEmail("new@example.com");
        request.setPassword("Test@123");
        request.setUsername("newuser");

        when(userMapper.selectByCondition(any())).thenReturn(Collections.emptyList());
        when(userMapper.insert(any())).thenReturn(1);

        // When
        Result<Void> result = userService.register(request);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(userMapper).insert(argThat(user ->
            user.getEmail().equals("new@example.com") &&
            user.getUsername().equals("newuser")
        ));
    }

    @Test
    @DisplayName("用户注册失败 - 邮箱已存在")
    void register_Fail_EmailExists() {
        // Given
        RegisterRequest request = new RegisterRequest();
        request.setEmail("test@example.com");

        when(userMapper.selectByCondition(any())).thenReturn(List.of(testUser));

        // When
        Result<Void> result = userService.register(request);

        // Then
        assertThat(result.getCode()).isEqualTo(400);
        assertThat(result.getMessage()).contains("邮箱已被注册");
    }

    @Test
    @DisplayName("用户登录成功 - 正确凭证")
    void login_Success_ValidCredentials() {
        // Given
        LoginRequest request = new LoginRequest();
        request.setEmail("test@example.com");
        request.setPassword("Test@123");

        when(userMapper.selectByCondition(any())).thenReturn(List.of(testUser));

        // When
        Result<LoginResponse> result = userService.login(request);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        assertThat(result.getData().getToken()).isNotEmpty();
    }

    @Test
    @DisplayName("用户登录失败 - 密码错误")
    void login_Fail_WrongPassword() {
        // Given
        LoginRequest request = new LoginRequest();
        request.setEmail("test@example.com");
        request.setPassword("wrongpassword");

        when(userMapper.selectByCondition(any())).thenReturn(List.of(testUser));

        // When
        Result<LoginResponse> result = userService.login(request);

        // Then
        assertThat(result.getCode()).isEqualTo(401);
        assertThat(result.getMessage()).contains("密码错误");
    }

    @Test
    @DisplayName("用户登录失败 - 用户不存在")
    void login_Fail_UserNotExists() {
        // Given
        LoginRequest request = new LoginRequest();
        request.setEmail("notexist@example.com");

        when(userMapper.selectByCondition(any())).thenReturn(Collections.emptyList());

        // When
        Result<LoginResponse> result = userService.login(request);

        // Then
        assertThat(result.getCode()).isEqualTo(404);
        assertThat(result.getMessage()).contains("用户不存在");
    }
}
```

#### 2.2.2 CoffeeService 测试

```java
@SpringBootTest
class CoffeeServiceTest {

    @Mock
    private CoffeeMapper coffeeMapper;

    @InjectMocks
    private CoffeeService coffeeService;

    @Test
    @DisplayName("获取咖啡列表成功")
    void getCoffeeList_Success() {
        // Given
        PageRequest request = new PageRequest();
        request.setPageNum(1);
        request.setPageSize(12);

        Coffee coffee1 = new Coffee();
        coffee1.setId(1L);
        coffee1.setName("经典拿铁");
        coffee1.setPrice(BigDecimal.valueOf(5.50));

        Coffee coffee2 = new Coffee();
        coffee2.setId(2L);
        coffee2.setName("卡布奇诺");
        coffee2.setPrice(BigDecimal.valueOf(5.00));

        when(coffeeMapper.selectByCondition(any())).thenReturn(List.of(coffee1, coffee2));
        when(coffeeMapper.selectCountByCondition(any())).thenReturn(2L);

        // When
        Result<PageResult<CoffeeVO>> result = coffeeService.getCoffeeList(request);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        assertThat(result.getData().getRecords()).hasSize(2);
        assertThat(result.getData().getTotal()).isEqualTo(2);
    }

    @Test
    @DisplayName("获取咖啡详情成功")
    void getCoffeeDetail_Success() {
        // Given
        Long coffeeId = 1L;
        Coffee coffee = new Coffee();
        coffee.setId(coffeeId);
        coffee.setName("经典拿铁");
        coffee.setDescription("丝滑奶泡与浓缩咖啡");
        coffee.setPrice(BigDecimal.valueOf(5.50));

        when(coffeeMapper.selectOneById(coffeeId)).thenReturn(coffee);

        // When
        Result<CoffeeVO> result = coffeeService.getCoffeeDetail(coffeeId);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        assertThat(result.getData().getName()).isEqualTo("经典拿铁");
    }

    @Test
    @DisplayName("获取咖啡详情失败 - 产品不存在")
    void getCoffeeDetail_Fail_NotExists() {
        // Given
        Long coffeeId = 999L;
        when(coffeeMapper.selectOneById(coffeeId)).thenReturn(null);

        // When
        Result<CoffeeVO> result = coffeeService.getCoffeeDetail(coffeeId);

        // Then
        assertThat(result.getCode()).isEqualTo(404);
    }

    @Test
    @DisplayName("按分类筛选咖啡")
    void getCoffeeList_ByCategory() {
        // Given
        String category = "拿铁";
        PageRequest request = new PageRequest();
        request.setCategory(category);

        Coffee coffee = new Coffee();
        coffee.setCategory(category);

        when(coffeeMapper.selectByCondition(argThat(condition ->
            condition.getWhere().get("category").equals(category)
        ))).thenReturn(List.of(coffee));

        // When
        Result<PageResult<CoffeeVO>> result = coffeeService.getCoffeeList(request);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(coffeeMapper).selectByCondition(argThat(condition ->
            condition.getWhere().get("category").equals(category)
        ));
    }
}
```

#### 2.2.3 CartService 测试

```java
@SpringBootTest
class CartServiceTest {

    @Mock
    private CartMapper cartMapper;

    @Mock
    private CoffeeMapper coffeeMapper;

    @InjectMocks
    private CartService cartService;

    @Test
    @DisplayName("添加商品到购物车成功 - 新商品")
    void addToCart_Success_NewItem() {
        // Given
        Long userId = 1L;
        Long coffeeId = 1L;
        Integer quantity = 1;

        Coffee coffee = new Coffee();
        coffee.setId(coffeeId);
        coffee.setPrice(BigDecimal.valueOf(5.50));
        coffee.setStock(100);

        when(cartMapper.selectByCondition(any())).thenReturn(Collections.emptyList());
        when(coffeeMapper.selectOneById(coffeeId)).thenReturn(coffee);
        when(cartMapper.insert(any())).thenReturn(1);

        // When
        Result<Void> result = cartService.addToCart(userId, coffeeId, quantity);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(cartMapper).insert(argThat(cart ->
            cart.getUserId().equals(userId) &&
            cart.getCoffeeId().equals(coffeeId) &&
            cart.getQuantity().equals(quantity)
        ));
    }

    @Test
    @DisplayName("添加商品到购物车成功 - 已存在商品")
    void addToCart_Success_ExistingItem() {
        // Given
        Long userId = 1L;
        Long coffeeId = 1L;
        Integer quantity = 1;

        Cart existingCart = new Cart();
        existingCart.setId(1L);
        existingCart.setQuantity(1);

        when(cartMapper.selectByCondition(any())).thenReturn(List.of(existingCart));
        when(cartMapper.update(any())).thenReturn(1);

        // When
        Result<Void> result = cartService.addToCart(userId, coffeeId, quantity);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(cartMapper).update(argThat(cart ->
            cart.getQuantity().equals(2)
        ));
    }

    @Test
    @DisplayName("添加商品失败 - 库存不足")
    void addToCart_Fail_OutOfStock() {
        // Given
        Long userId = 1L;
        Long coffeeId = 1L;

        Coffee coffee = new Coffee();
        coffee.setId(coffeeId);
        coffee.setStock(0);

        when(coffeeMapper.selectOneById(coffeeId)).thenReturn(coffee);

        // When
        Result<Void> result = cartService.addToCart(userId, coffeeId, 1);

        // Then
        assertThat(result.getCode()).isEqualTo(400);
        assertThat(result.getMessage()).contains("库存不足");
    }

    @Test
    @DisplayName("删除购物车商品成功")
    void removeFromCart_Success() {
        // Given
        Long cartId = 1L;
        when(cartMapper.deleteById(cartId)).thenReturn(1);

        // When
        Result<Void> result = cartService.removeFromCart(cartId);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(cartMapper).deleteById(cartId);
    }

    @Test
    @DisplayName("清空购物车成功")
    void clearCart_Success() {
        // Given
        Long userId = 1L;
        when(cartMapper.deleteByCondition(any())).thenReturn(1);

        // When
        Result<Void> result = cartService.clearCart(userId);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(cartMapper).deleteByCondition(argThat(condition ->
            condition.getWhere().get("user_id").equals(userId)
        ));
    }
}
```

#### 2.2.4 OrderService 测试

```java
@SpringBootTest
class OrderServiceTest {

    @Mock
    private OrderMapper orderMapper;

    @Mock
    private OrderItemMapper orderItemMapper;

    @Mock
    private CartMapper cartMapper;

    @Mock
    private CoffeeMapper coffeeMapper;

    @InjectMocks
    private OrderService orderService;

    @Test
    @DisplayName("创建订单成功 - 堂食")
    void createOrder_Success_DineIn() {
        // Given
        Long userId = 1L;
        CreateOrderRequest request = new CreateOrderRequest();
        request.setOrderType(0); // 堂食

        Cart cart1 = new Cart();
        cart1.setCoffeeId(1L);
        cart1.setQuantity(2);
        cart1.setPrice(BigDecimal.valueOf(5.50));

        Coffee coffee1 = new Coffee();
        coffee1.setId(1L);
        coffee1.setPrice(BigDecimal.valueOf(5.50));
        coffee1.setStock(100);

        when(cartMapper.selectByCondition(any())).thenReturn(List.of(cart1));
        when(coffeeMapper.selectOneById(1L)).thenReturn(coffee1);
        when(orderMapper.insert(any())).thenReturn(1);
        when(orderItemMapper.insertBatch(any())).thenReturn(1);
        when(cartMapper.deleteByCondition(any())).thenReturn(1);

        // When
        Result<CreateOrderResponse> result = orderService.createOrder(userId, request);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        assertThat(result.getData().getOrderId()).isNotNull();
        assertThat(result.getData().getTotalPrice()).isEqualTo(BigDecimal.valueOf(11.00));
    }

    @Test
    @DisplayName("创建订单失败 - 购物车为空")
    void createOrder_Fail_EmptyCart() {
        // Given
        Long userId = 1L;
        CreateOrderRequest request = new CreateOrderRequest();

        when(cartMapper.selectByCondition(any())).thenReturn(Collections.emptyList());

        // When
        Result<CreateOrderResponse> result = orderService.createOrder(userId, request);

        // Then
        assertThat(result.getCode()).isEqualTo(400);
        assertThat(result.getMessage()).contains("购物车为空");
    }

    @Test
    @DisplayName("创建订单失败 - 外卖缺少地址")
    void createOrder_Fail_MissingAddress() {
        // Given
        Long userId = 1L;
        CreateOrderRequest request = new CreateOrderRequest();
        request.setOrderType(2); // 外卖
        request.setAddress(null);

        // When
        Result<CreateOrderResponse> result = orderService.createOrder(userId, request);

        // Then
        assertThat(result.getCode()).isEqualTo(400);
        assertThat(result.getMessage()).contains("请输入配送地址");
    }

    @Test
    @DisplayName("订单状态流转 - 待支付到已支付")
    void updateOrderStatus_ToPaid() {
        // Given
        Long orderId = 1L;
        Order order = new Order();
        order.setId(orderId);
        order.setStatus(0); // 待支付

        when(orderMapper.selectOneById(orderId)).thenReturn(order);
        when(orderMapper.update(any())).thenReturn(1);

        // When
        Result<Void> result = orderService.updateOrderStatus(orderId, 1);

        // Then
        assertThat(result.getCode()).isEqualTo(200);
        verify(orderMapper).update(argThat(o ->
            o.getStatus().equals(1)
        ));
    }
}
```

---

## 3. 集成测试计划

### 3.1 Controller 层集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@Sql(scripts = "/test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
class UserControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private UserMapper userMapper;

    @Test
    @DisplayName("用户注册 API 集成测试")
    void register_API_Success() throws Exception {
        // Given
        RegisterRequest request = new RegisterRequest();
        request.setEmail("integration@example.com");
        request.setPassword("Test@123");
        request.setUsername("integrationuser");

        // When & Then
        mockMvc.perform(post("/api/user/register")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.message").value("注册成功"));

        // 验证数据库
        List<User> users = userMapper.selectByCondition(
            Condition.create().eq("email", "integration@example.com")
        );
        assertThat(users).hasSize(1);
    }

    @Test
    @DisplayName("用户登录 API 集成测试")
    void login_API_Success() throws Exception {
        // Given - 先注册用户
        RegisterRequest registerRequest = new RegisterRequest();
        registerRequest.setEmail("login@example.com");
        registerRequest.setPassword("Test@123");
        registerRequest.setUsername("loginuser");

        mockMvc.perform(post("/api/user/register")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(registerRequest)));

        LoginRequest loginRequest = new LoginRequest();
        loginRequest.setEmail("login@example.com");
        loginRequest.setPassword("Test@123");

        // When & Then
        mockMvc.perform(post("/api/user/login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(loginRequest)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.token").isNotEmpty())
                .andExpect(jsonPath("$.data.user.email").value("login@example.com"));
    }
}
```

### 3.2 咖啡产品 API 集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class CoffeeControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private CoffeeMapper coffeeMapper;

    @Test
    @DisplayName("获取咖啡列表 API 集成测试")
    void getCoffeeList_API_Success() throws Exception {
        // Given
        Coffee coffee = new Coffee();
        coffee.setName("测试拿铁");
        coffee.setPrice(BigDecimal.valueOf(5.50));
        coffee.setCategory("拿铁");
        coffee.setStatus(1);
        coffeeMapper.insert(coffee);

        // When & Then
        mockMvc.perform(get("/api/coffee/list")
                .param("pageNum", "1")
                .param("pageSize", "12"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.records").isArray())
                .andExpect(jsonPath("$.data.total").isNumber());
    }

    @Test
    @DisplayName("获取咖啡详情 API 集成测试")
    void getCoffeeDetail_API_Success() throws Exception {
        // Given
        Coffee coffee = new Coffee();
        coffee.setName("测试拿铁");
        coffee.setDescription("测试描述");
        coffee.setPrice(BigDecimal.valueOf(5.50));
        coffeeMapper.insert(coffee);
        Long coffeeId = coffee.getId();

        // When & Then
        mockMvc.perform(get("/api/coffee/detail")
                .param("id", coffeeId.toString()))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.name").value("测试拿铁"))
                .andExpect(jsonPath("$.data.price").value(5.50));
    }

    @Test
    @DisplayName("按分类筛选咖啡 API 集成测试")
    void getCoffeeListByCategory_API_Success() throws Exception {
        // Given
        Coffee coffee1 = new Coffee();
        coffee1.setName("拿铁1");
        coffee1.setCategory("拿铁");
        coffeeMapper.insert(coffee1);

        Coffee coffee2 = new Coffee();
        coffee2.setName("卡布奇诺1");
        coffee2.setCategory("卡布奇诺");
        coffeeMapper.insert(coffee2);

        // When & Then
        mockMvc.perform(get("/api/coffee/list")
                .param("category", "拿铁"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.records[0].category").value("拿铁"));
    }
}
```

### 3.3 购物车 API 集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class CartControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private CartMapper cartMapper;

    @Autowired
    private CoffeeMapper coffeeMapper;

    private String userToken;

    @BeforeEach
    void setUp() {
        // 注册并登录获取 Token
        // ... 省略注册登录代码
    }

    @Test
    @DisplayName("添加商品到购物车 API 集成测试")
    void addToCart_API_Success() throws Exception {
        // Given
        Coffee coffee = new Coffee();
        coffee.setName("测试咖啡");
        coffee.setPrice(BigDecimal.valueOf(5.50));
        coffee.setStock(100);
        coffeeMapper.insert(coffee);

        AddToCartRequest request = new AddToCartRequest();
        request.setCoffeeId(coffee.getId());
        request.setQuantity(1);

        // When & Then
        mockMvc.perform(post("/api/cart/add")
                .header("Authorization", "Bearer " + userToken)
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200));

        // 验证购物车
        List<Cart> cartItems = cartMapper.selectByCondition(
            Condition.create().eq("coffee_id", coffee.getId())
        );
        assertThat(cartItems).hasSize(1);
    }

    @Test
    @DisplayName("获取购物车列表 API 集成测试")
    void getCartList_API_Success() throws Exception {
        // Given - 添加购物车商品
        Coffee coffee = new Coffee();
        coffee.setName("测试咖啡");
        coffee.setPrice(BigDecimal.valueOf(5.50));
        coffeeMapper.insert(coffee);

        Cart cart = new Cart();
        cart.setUserId(1L); // 假设用户 ID 为 1
        cart.setCoffeeId(coffee.getId());
        cart.setQuantity(2);
        cart.setPrice(coffee.getPrice());
        cartMapper.insert(cart);

        // When & Then
        mockMvc.perform(get("/api/cart/list")
                .header("Authorization", "Bearer " + userToken))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").isArray())
                .andExpect(jsonPath("$.data[0].quantity").value(2));
    }

    @Test
    @DisplayName("删除购物车商品 API 集成测试")
    void removeFromCart_API_Success() throws Exception {
        // Given
        Cart cart = new Cart();
        cart.setUserId(1L);
        cart.setCoffeeId(1L);
        cart.setQuantity(1);
        cartMapper.insert(cart);
        Long cartId = cart.getId();

        // When & Then
        mockMvc.perform(post("/api/cart/remove")
                .header("Authorization", "Bearer " + userToken)
                .param("cartId", cartId.toString()))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200));

        // 验证删除
        Cart deletedCart = cartMapper.selectOneById(cartId);
        assertThat(deletedCart).isNull();
    }
}
```

### 3.4 订单 API 集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@TransactionConfiguration(defaultRollback = true)
class OrderControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private OrderMapper orderMapper;

    @Autowired
    private CartMapper cartMapper;

    private String userToken;

    @Test
    @DisplayName("创建订单 API 集成测试")
    void createOrder_API_Success() throws Exception {
        // Given - 准备购物车数据
        // ... 添加购物车商品

        CreateOrderRequest request = new CreateOrderRequest();
        request.setOrderType(0); // 堂食

        // When & Then
        mockMvc.perform(post("/api/order/create")
                .header("Authorization", "Bearer " + userToken)
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.orderId").isNotNull())
                .andExpect(jsonPath("$.data.totalPrice").isNumber());

        // 验证订单创建
        // ... 验证数据库订单
    }

    @Test
    @DisplayName("获取订单列表 API 集成测试")
    void getOrderList_API_Success() throws Exception {
        // Given - 创建测试订单
        Order order = new Order();
        order.setUserId(1L);
        order.setTotalPrice(BigDecimal.valueOf(15.50));
        order.setStatus(1);
        orderMapper.insert(order);

        // When & Then
        mockMvc.perform(get("/api/order/list")
                .header("Authorization", "Bearer " + userToken)
                .param("pageNum", "1")
                .param("pageSize", "10"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.records").isArray());

    @Test
    @DisplayName("订单状态流转 API 集成测试")
    void updateOrderStatus_API_Success() throws Exception {
        // Given - 创建待支付订单
        Order order = new Order();
        order.setUserId(1L);
        order.setStatus(0); // 待支付
        orderMapper.insert(order);

        UpdateOrderStatusRequest request = new UpdateOrderStatusRequest();
        request.setOrderId(order.getId());
        request.setStatus(1); // 已支付

        // When & Then
        mockMvc.perform(post("/api/order/update-status")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200));

        // 验证状态更新
        Order updatedOrder = orderMapper.selectOneById(order.getId());
        assertThat(updatedOrder.getStatus()).isEqualTo(1);
    }
}
```

---

## 4. 数据访问层测试

### 4.1 Mapper 测试

```java
@DataMybatisBootTest
class UserMapperTest {

    @Autowired
    private UserMapper userMapper;

    @Test
    @DisplayName("插入用户成功")
    void insert_Success() {
        // Given
        User user = new User();
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        user.setPassword("$2a$10$encodedPassword");

        // When
        int result = userMapper.insert(user);

        // Then
        assertThat(result).isEqualTo(1);
        assertThat(user.getId()).isNotNull();
    }

    @Test
    @DisplayName("根据邮箱查询用户")
    void selectByCondition_Email() {
        // Given
        User user = new User();
        user.setEmail("unique@example.com");
        userMapper.insert(user);

        // When
        List<User> users = userMapper.selectByCondition(
            Condition.create().eq("email", "unique@example.com")
        );

        // Then
        assertThat(users).hasSize(1);
        assertThat(users.get(0).getEmail()).isEqualTo("unique@example.com");
    }

    @Test
    @DisplayName("更新用户信息")
    void update_Success() {
        // Given
        User user = new User();
        user.setUsername("oldname");
        userMapper.insert(user);

        user.setUsername("newname");

        // When
        int result = userMapper.update(user);

        // Then
        assertThat(result).isEqualTo(1);
        User updated = userMapper.selectOneById(user.getId());
        assertThat(updated.getUsername()).isEqualTo("newname");
    }
}
```

---

## 5. 安全测试

### 5.1 JWT 认证测试

```java
@SpringBootTest
class JwtAuthenticationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private JwtUtil jwtUtil;

    @Test
    @DisplayName("未携带 Token 访问受保护接口")
    void accessProtectedResource_NoToken() throws Exception {
        mockMvc.perform(get("/api/cart/list"))
                .andExpect(status().isUnauthorized());
    }

    @Test
    @DisplayName("携带有效 Token 访问受保护接口")
    void accessProtectedResource_ValidToken() throws Exception {
        String token = jwtUtil.generateToken(1L, "test@example.com");

        mockMvc.perform(get("/api/cart/list")
                .header("Authorization", "Bearer " + token))
                .andExpect(status().isOk());
    }

    @Test
    @DisplayName("携带过期 Token 访问受保护接口")
    void accessProtectedResource_ExpiredToken() throws Exception {
        // 生成已过期的 Token
        String token = jwtUtil.generateToken(1L, "test@example.com");

        mockMvc.perform(get("/api/cart/list")
                .header("Authorization", "Bearer " + token))
                .andExpect(status().isUnauthorized());
    }
}
```

### 5.2 输入验证测试

```java
@SpringBootTest
class InputValidationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    @DisplayName("SQL 注入防护测试")
    void sqlInjection_Protection() throws Exception {
        LoginRequest request = new LoginRequest();
        request.setEmail("' OR '1'='1");
        request.setPassword("anything");

        mockMvc.perform(post("/api/user/login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isNotFound()); // 应该返回用户不存在
    }

    @Test
    @DisplayName("XSS 防护测试")
    void xss_Protection() throws Exception {
        RegisterRequest request = new RegisterRequest();
        request.setEmail("<script>alert('xss')</script>@example.com");
        request.setPassword("Test@123");

        mockMvc.perform(post("/api/user/register")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isBadRequest()); // 邮箱格式验证失败
    }
}
```

---

## 6. 性能测试

### 6.1 并发测试

```java
@SpringBootTest
class ConcurrencyTest {

    @Autowired
    private OrderService orderService;

    @Autowired
    private CoffeeMapper coffeeMapper;

    @Test
    @DisplayName("并发创建订单测试")
    void concurrentCreateOrder() throws InterruptedException {
        // Given
        int threadCount = 100;
        CountDownLatch latch = new CountDownLatch(threadCount);
        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failCount = new AtomicInteger(0);

        ExecutorService executor = Executors.newFixedThreadPool(threadCount);

        // When
        for (int i = 0; i < threadCount; i++) {
            executor.submit(() -> {
                try {
                    CreateOrderRequest request = new CreateOrderRequest();
                    request.setOrderType(0);
                    Result<CreateOrderResponse> result = orderService.createOrder(1L, request);
                    if (result.getCode() == 200) {
                        successCount.incrementAndGet();
                    } else {
                        failCount.incrementAndGet();
                    }
                } finally {
                    latch.countDown();
                }
            });
        }

        latch.await(30, TimeUnit.SECONDS);

        // Then
        System.out.println("成功: " + successCount.get() + ", 失败: " + failCount.get());
        assertThat(successCount.get() + failCount.get()).isEqualTo(threadCount);
    }
}
```

---

## 7. 测试覆盖率目标

| 层级 | 目标覆盖率 |
|------|-----------|
| Controller | 80% |
| Service | 90% |
| Mapper | 70% |
| 整体 | 75% |

---

## 8. 测试执行

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=UserServiceTest

# 生成覆盖率报告
mvn jacoco:report

# 运行集成测试
mvn verify -P integration-test
```

---

*文档创建时间：2026-02-26*

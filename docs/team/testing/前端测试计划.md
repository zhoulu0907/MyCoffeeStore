# MyCoffeeStore 前端测试计划

> **文档版本**: v1.0
> **创建时间**: 2026-02-26
> **测试负责人**: 测试工程师

---

## 1. 测试概述

### 1.1 前端技术栈

```
框架: React 18
构建工具: Vite
语言: TypeScript
路由: React Router v6
状态管理: React Context API
HTTP 客户端: Axios
样式: CSS Modules + Tailwind CSS
```

### 1.2 测试工具选型

| 工具类型 | 工具名称 | 用途 |
|----------|----------|------|
| 单元测试 | Jest + React Testing Library | 组件测试 |
| E2E 测试 | Playwright | 端到端测试 |
| 视觉测试 | Chromatic | UI 回归测试 |
| 代码覆盖率 | Istanbul/Jest | 覆盖率统计 |

---

## 2. 单元测试计划

### 2.1 测试框架配置

#### Jest 配置
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.ts'],
  moduleNameMapper: {
    '\\.(css|less|scss)$': 'identity-obj-proxy',
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/main.tsx',
    '!src/vite-env.d.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
};
```

#### React Testing Library 配置
```typescript
// src/setupTests.ts
import '@testing-library/jest-dom';
```

### 2.2 组件测试用例

#### 2.2.1 通用组件测试

**Button 组件**
```typescript
describe('Button', () => {
  it('should render button with text', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('should call onClick handler when clicked', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    fireEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('should be disabled when disabled prop is true', () => {
    render(<Button disabled>Click me</Button>);
    expect(screen.getByText('Click me')).toBeDisabled();
  });

  it('should apply primary variant styles', () => {
    render(<Button variant="primary">Click me</Button>);
    expect(screen.getByText('Click me')).toHaveClass('btn-primary');
  });
});
```

**Input 组件**
```typescript
describe('Input', () => {
  it('should render input with placeholder', () => {
    render(<Input placeholder="Enter email" />);
    expect(screen.getByPlaceholderText('Enter email')).toBeInTheDocument();
  });

  it('should update value on change', () => {
    render(<Input value="" onChange={jest.fn()} />);
    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'test@example.com' } });
    expect(input).toHaveValue('test@example.com');
  });

  it('should display error message', () => {
    render(<Input error="Invalid email" />);
    expect(screen.getByText('Invalid email')).toBeInTheDocument();
  });
});
```

**Card 组件**
```typescript
describe('CoffeeCard', () => {
  const mockCoffee = {
    id: 1,
    name: '经典拿铁',
    price: 5.50,
    imageUrl: '/latte.jpg',
    description: '丝滑奶泡与浓缩咖啡',
  };

  it('should render coffee information', () => {
    render(<CoffeeCard coffee={mockCoffee} />);
    expect(screen.getByText('经典拿铁')).toBeInTheDocument();
    expect(screen.getByText('$5.50')).toBeInTheDocument();
  });

  it('should call onAddToCart when button clicked', () => {
    const handleAdd = jest.fn();
    render(<CoffeeCard coffee={mockCoffee} onAddToCart={handleAdd} />);
    fireEvent.click(screen.getByText('加入购物车'));
    expect(handleAdd).toHaveBeenCalledWith(mockCoffee);
  });
});
```

#### 2.2.2 页面组件测试

**Login 页面**
```typescript
describe('LoginPage', () => {
  it('should render login form', () => {
    render(<LoginPage />);
    expect(screen.getByPlaceholderText('邮箱/用户名')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('密码')).toBeInTheDocument();
    expect(screen.getByText('登录')).toBeInTheDocument();
  });

  it('should show error when fields are empty', async () => {
    render(<LoginPage />);
    fireEvent.click(screen.getByText('登录'));
    expect(await screen.findByText('请输入账号')).toBeInTheDocument();
  });

  it('should call login API with correct credentials', async () => {
    const mockLogin = jest.fn().mockResolvedValue({ token: 'abc123' });
    render(<LoginPage />);
    fireEvent.change(screen.getByPlaceholderText('邮箱/用户名'), {
      target: { value: 'test@example.com' }
    });
    fireEvent.change(screen.getByPlaceholderText('密码'), {
      target: { value: 'password123' }
    });
    fireEvent.click(screen.getByText('登录'));
    await waitFor(() => expect(mockLogin).toHaveBeenCalled());
  });
});
```

**CoffeeList 页面**
```typescript
describe('CoffeeListPage', () => {
  it('should render coffee list', async () => {
    const mockCoffees = [
      { id: 1, name: '拿铁', price: 5.50 },
      { id: 2, name: '卡布奇诺', price: 5.00 },
    ];
    jest.spyOn(api, 'getCoffees').mockResolvedValue(mockCoffees);
    render(<CoffeeListPage />);
    await waitFor(() => {
      expect(screen.getByText('拿铁')).toBeInTheDocument();
      expect(screen.getByText('卡布奇诺')).toBeInTheDocument();
    });
  });

  it('should filter coffees by category', async () => {
    render(<CoffeeListPage />);
    fireEvent.click(screen.getByText('拿铁'));
    await waitFor(() => {
      expect(screen.getAllByTestId('coffee-card').length).toBeGreaterThan(0);
    });
  });
});
```

**Cart 页面**
```typescript
describe('CartPage', () => {
  it('should render empty cart when no items', () => {
    jest.spyOn(cartContext, 'useCart').mockReturnValue({ items: [] });
    render(<CartPage />);
    expect(screen.getByText('购物车为空')).toBeInTheDocument();
  });

  it('should calculate total correctly', () => {
    const mockItems = [
      { coffee: { id: 1, price: 5.50 }, quantity: 2 },
      { coffee: { id: 2, price: 3.00 }, quantity: 1 },
    ];
    jest.spyOn(cartContext, 'useCart').mockReturnValue({ items: mockItems });
    render(<CartPage />);
    expect(screen.getByText('$14.00')).toBeInTheDocument();
  });
});
```

### 2.3 Hooks 测试

**useAuth Hook**
```typescript
describe('useAuth', () => {
  it('should return user when logged in', () => {
    const mockUser = { id: 1, username: 'testuser' };
    jest.spyOn(localStorage, 'getItem').mockReturnValue(JSON.stringify(mockUser));
    const { result } = renderHook(() => useAuth());
    expect(result.current.user).toEqual(mockUser);
  });

  it('should login and store token', async () => {
    const mockLogin = jest.fn().mockResolvedValue({ token: 'abc123', user: { id: 1 } });
    const { result } = renderHook(() => useAuth());
    await act(async () => {
      await result.current.login('test@example.com', 'password');
    });
    expect(localStorage.getItem('token')).toBe('abc123');
  });
});
```

**useCart Hook**
```typescript
describe('useCart', () => {
  it('should add item to cart', () => {
    const { result } = renderHook(() => useCart());
    act(() => {
      result.current.addItem({ id: 1, name: '拿铁', price: 5.50 });
    });
    expect(result.current.items).toHaveLength(1);
  });

  it('should update quantity when adding existing item', () => {
    const { result } = renderHook(() => useCart());
    const item = { id: 1, name: '拿铁', price: 5.50 };
    act(() => {
      result.current.addItem(item);
      result.current.addItem(item);
    });
    expect(result.current.items[0].quantity).toBe(2);
  });
});
```

---

## 3. E2E 测试计划

### 3.1 Playwright 配置

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    port: 5173,
    reuseExistingServer: !process.env.CI,
  },
});
```

### 3.2 E2E 测试用例

#### 3.2.1 用户认证流程

```typescript
import { test, expect } from '@playwright/test';

test.describe('User Authentication', () => {
  test('should register new user', async ({ page }) => {
    await page.goto('/register');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test@123');
    await page.fill('input[name="confirmPassword"]', 'Test@123');
    await page.click('button[type="submit"]');
    await expect(page).toHaveURL('/');
    await expect(page.locator('text=欢迎')).toBeVisible();
  });

  test('should login with valid credentials', async ({ page }) => {
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test@123');
    await page.click('button[type="submit"]');
    await expect(page).toHaveURL('/');
    await expect(page.locator('text=test@example.com')).toBeVisible();
  });

  test('should show error with invalid credentials', async ({ page }) => {
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'wrongpassword');
    await page.click('button[type="submit"]');
    await expect(page.locator('text=用户名或密码错误')).toBeVisible();
  });
});
```

#### 3.2.2 咖啡浏览流程

```typescript
test.describe('Coffee Browsing', () => {
  test('should display coffee list', async ({ page }) => {
    await page.goto('/coffee');
    const cards = await page.locator('[data-testid="coffee-card"]').count();
    expect(cards).toBeGreaterThan(0);
  });

  test('should filter coffees by category', async ({ page }) => {
    await page.goto('/coffee');
    await page.click('text=拿铁');
    const filteredCards = await page.locator('[data-testid="coffee-card"]').count();
    expect(filteredCards).toBeGreaterThan(0);
  });

  test('should navigate to coffee detail', async ({ page }) => {
    await page.goto('/coffee');
    await page.click('[data-testid="coffee-card"]:first-child');
    await expect(page).toHaveURL(/\/coffee\/\d+/);
    await expect(page.locator('h1')).toBeVisible();
  });
});
```

#### 3.2.3 购物车流程

```typescript
test.describe('Shopping Cart', () => {
  test('should add coffee to cart', async ({ page }) => {
    await page.goto('/coffee/1');
    await page.click('text=加入购物车');
    await expect(page.locator('[data-testid="cart-count"]')).toHaveText('1');
  });

  test('should update cart quantity', async ({ page }) => {
    // 先登录并添加商品
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test@123');
    await page.click('button[type="submit"]');

    await page.goto('/cart');
    await page.click('[data-testid="increase-quantity"]');
    await expect(page.locator('[data-testid="item-quantity"]')).toHaveText('2');
  });

  test('should remove item from cart', async ({ page }) => {
    await page.goto('/cart');
    const initialCount = await page.locator('[data-testid="cart-item"]').count();
    await page.click('[data-testid="remove-item"]:first-child');
    const newCount = await page.locator('[data-testid="cart-item"]').count();
    expect(newCount).toBe(initialCount - 1);
  });
});
```

#### 3.2.4 订单流程

```typescript
test.describe('Order Flow', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'Test@123');
    await page.click('button[type="submit"]');
  });

  test('should create order successfully', async ({ page }) => {
    // 添加商品到购物车
    await page.goto('/coffee/1');
    await page.click('text=加入购物车');

    // 结算
    await page.goto('/cart');
    await page.click('text=去结算');

    // 选择订单类型
    await page.click('label:has-text("堂食")');
    await page.click('text=提交订单');

    // 验证
    await expect(page.locator('text=订单创建成功')).toBeVisible();
  });

  test('should display order in order list', async ({ page }) => {
    await page.goto('/orders');
    const orders = await page.locator('[data-testid="order-card"]').count();
    expect(orders).toBeGreaterThan(0);
  });
});
```

---

## 4. 响应式布局测试

### 4.1 断点测试

```typescript
const devices = [
  { name: 'iPhone SE', width: 375, height: 667 },
  { name: 'iPhone 12 Pro', width: 390, height: 844 },
  { name: 'iPad', width: 768, height: 1024 },
  { name: 'Desktop', width: 1920, height: 1080 },
];

test.describe('Responsive Layout', () => {
  devices.forEach(device => {
    test(`should display correctly on ${device.name}`, async ({ page }) => {
      await page.setViewportSize({ width: device.width, height: device.height });
      await page.goto('/');

      // 验证导航栏
      if (device.width < 768) {
        await expect(page.locator('[data-testid="mobile-menu"]')).toBeVisible();
      } else {
        await expect(page.locator('[data-testid="desktop-nav"]')).toBeVisible();
      }

      // 验证产品列表列数
      await page.goto('/coffee');
      const cards = await page.locator('[data-testid="coffee-card"]');
      if (device.width < 768) {
        // 移动端应该是 1 列
        await expect(cards.first()).toHaveCSS('grid-template-columns', '1fr');
      } else if (device.width < 1024) {
        // 平板应该是 2 列
        await expect(cards.first()).toHaveCSS('grid-template-columns', 'repeat(2, 1fr)');
      } else {
        // 桌面应该是 4 列
        await expect(cards.first()).toHaveCSS('grid-template-columns', 'repeat(4, 1fr)');
      }
    });
  });
});
```

### 4.2 横竖屏测试

```typescript
test('should handle orientation change', async ({ page }) => {
  await page.setViewportSize({ width: 390, height: 844 });
  await page.goto('/coffee');
  let portraitCards = await page.locator('[data-testid="coffee-card"]').count();

  await page.setViewportSize({ width: 844, height: 390 });
  await page.reload();
  let landscapeCards = await page.locator('[data-testid="coffee-card"]').count();

  // 横屏应该显示更多列
  expect(landscapeCards).toBeGreaterThanOrEqual(portraitCards);
});
```

---

## 5. 性能测试

### 5.1 页面加载性能

```typescript
test.describe('Performance', () => {
  test('should load home page within 2 seconds', async ({ page }) => {
    const startTime = Date.now();
    await page.goto('/');
    await page.waitForLoadState('networkidle');
    const loadTime = Date.now() - startTime;
    expect(loadTime).toBeLessThan(2000);
  });

  test('should have less than 50ms input delay', async ({ page }) => {
    await page.goto('/coffee');
    const inputDelay = await page.evaluate(() => {
      return new Promise(resolve => {
        const start = performance.now();
        requestAnimationFrame(() => {
          resolve(performance.now() - start);
        });
      });
    });
    expect(inputDelay).toBeLessThan(50);
  });
});
```

### 5.2 图片懒加载测试

```typescript
test('should lazy load images', async ({ page }) => {
  await page.goto('/coffee');
  const images = page.locator('img[data-src]');
  const initialLoaded = await images.evaluateAll(imgs =>
    imgs.filter(img => img.complete).length
  );

  // 滚动到页面底部
  await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
  await page.waitForTimeout(500);

  const finalLoaded = await images.evaluateAll(imgs =>
    imgs.filter(img => img.complete).length
  );

  expect(finalLoaded).toBeGreaterThan(initialLoaded);
});
```

---

## 6. 可访问性测试

### 6.1 ARIA 属性测试

```typescript
test('should have proper ARIA labels', async ({ page }) => {
  await page.goto('/');
  const accessibilityTree = await page.accessibility.snapshot();
  // 验证按钮有可访问名称
  const buttons = await page.locator('button').all();
  for (const button of buttons) {
    const name = await button.getAttribute('aria-label');
    const text = await button.textContent();
    expect(name || text).toBeTruthy();
  }
});
```

### 6.2 键盘导航测试

```typescript
test('should be keyboard navigable', async ({ page }) => {
  await page.goto('/coffee');
  await page.keyboard.press('Tab');
  await page.keyboard.press('Enter');
  // 验证可以通过键盘操作
  await expect(page).toHaveURL(/\/coffee\/\d+/);
});
```

---

## 7. 测试执行命令

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:report": "playwright show-report"
  }
}
```

---

## 8. 测试报告

### 8.1 覆盖率目标

| 类型 | 目标覆盖率 |
|------|-----------|
| 语句覆盖率 | 70% |
| 分支覆盖率 | 70% |
| 函数覆盖率 | 70% |
| 行覆盖率 | 70% |

### 8.2 测试报告生成

```bash
# 单元测试覆盖率报告
npm run test:coverage

# E2E 测试报告
npm run test:e2e:report
```

---

*文档创建时间：2026-02-26*

# MyCoffeeStore 数据库设计

> 数据库：MySQL 8.0+
> 字符集：utf8mb4
> 排序规则：utf8mb4_unicode_ci

## 数据库命名规范

### 表命名规范
- 全部小写
- 使用下划线分隔单词
- 复数形式（如：users, coffees）
- 前缀：mcs_ (MyCoffeeStore 缩写)

### 字段命名规范
- 全部小写
- 使用下划线分隔单词
- 布尔值使用 is_ 前缀
- 时间戳使用 _at 后缀

---

## 1. 用户表 (mcs_user)

### 1.1 表结构

```sql
CREATE TABLE `mcs_user` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(32) NOT NULL COMMENT '用户名',
  `password` VARCHAR(128) NOT NULL COMMENT '密码（BCrypt加密）',
  `email` VARCHAR(64) NOT NULL COMMENT '邮箱',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `status` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-正常',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(64) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_phone` (`phone`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

### 1.2 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | 主键 | id | 主键索引 |
| uk_username | 唯一 | username | 用户名唯一 |
| uk_email | 唯一 | email | 邮箱唯一 |
| idx_phone | 普通 | phone | 手机号查询 |
| idx_create_time | 普通 | create_time | 按创建时间查询 |

---

## 2. 咖啡产品表 (mcs_coffee)

### 2.1 表结构

```sql
CREATE TABLE `mcs_coffee` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '咖啡ID',
  `name` VARCHAR(64) NOT NULL COMMENT '咖啡名称',
  `description` TEXT COMMENT '咖啡描述',
  `price` DECIMAL(10,2) NOT NULL COMMENT '现价',
  `original_price` DECIMAL(10,2) DEFAULT NULL COMMENT '原价',
  `category` VARCHAR(32) NOT NULL COMMENT '分类：espresso-意式，brew-手冲，cold-冷萃，blend-拼配',
  `category_name` VARCHAR(32) NOT NULL COMMENT '分类名称',
  `image_url` VARCHAR(255) NOT NULL COMMENT '主图URL',
  `images` JSON DEFAULT NULL COMMENT '图片列表（JSON数组）',
  `stock` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '库存数量',
  `sales` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '销量',
  `status` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：0-下架，1-上架，2-售罄',
  `sort_order` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '排序值（越大越靠前）',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_category` (`category`),
  KEY `idx_status` (`status`),
  KEY `idx_sort_order` (`sort_order` DESC),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='咖啡产品表';
```

### 2.2 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | 主键 | id | 主键索引 |
| idx_category | 普通 | category | 按分类查询 |
| idx_status | 普通 | status | 按状态查询 |
| idx_sort_order | 普通 | sort_order DESC | 排序查询 |
| idx_create_time | 普通 | create_time | 按创建时间查询 |

---

## 3. 购物车表 (mcs_cart)

### 3.1 表结构

```sql
CREATE TABLE `mcs_cart` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '购物车项ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `coffee_id` BIGINT UNSIGNED NOT NULL COMMENT '咖啡ID',
  `quantity` INT UNSIGNED NOT NULL DEFAULT 1 COMMENT '数量',
  `price` DECIMAL(10,2) NOT NULL COMMENT '添加时单价',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_coffee` (`user_id`, `coffee_id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_cart_user` FOREIGN KEY (`user_id`) REFERENCES `mcs_user` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_cart_coffee` FOREIGN KEY (`coffee_id`) REFERENCES `mcs_coffee` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='购物车表';
```

### 3.2 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | 主键 | id | 主键索引 |
| uk_user_coffee | 唯一 | user_id, coffee_id | 防止重复添加 |
| idx_user_id | 普通 | user_id | 按用户查询 |

### 3.3 外键关系

| 外键名 | 本表字段 | 关联表 | 关联字段 | 级联操作 |
|--------|----------|--------|----------|----------|
| fk_cart_user | user_id | mcs_user | id | CASCADE |
| fk_cart_coffee | coffee_id | mcs_coffee | id | CASCADE |

---

## 4. 订单表 (mcs_order)

### 4.1 表结构

```sql
CREATE TABLE `mcs_order` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
  `order_type` VARCHAR(20) NOT NULL COMMENT '订单类型：dine_in-堂食，takeaway-外带，delivery-外卖',
  `status` VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '订单状态：pending-待确认，confirmed-已确认，preparing-制作中，ready-待取餐，completed-已完成，cancelled-已取消',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `delivery_address` JSON DEFAULT NULL COMMENT '配送地址（外卖时必填）',
  `cancel_reason` VARCHAR(255) DEFAULT NULL COMMENT '取消原因',
  `paid_at` DATETIME DEFAULT NULL COMMENT '支付时间',
  `completed_at` DATETIME DEFAULT NULL COMMENT '完成时间',
  `cancelled_at` DATETIME DEFAULT NULL COMMENT '取消时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_order_user` FOREIGN KEY (`user_id`) REFERENCES `mcs_user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单表';
```

### 4.2 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | 主键 | id | 主键索引 |
| uk_order_no | 唯一 | order_no | 订单号唯一 |
| idx_user_id | 普通 | user_id | 按用户查询 |
| idx_status | 普通 | status | 按状态查询 |
| idx_create_time | 普通 | create_time | 按创建时间查询 |

### 4.3 外键关系

| 外键名 | 本表字段 | 关联表 | 关联字段 | 级联操作 |
|--------|----------|--------|----------|----------|
| fk_order_user | user_id | mcs_user | id | RESTRICT |

### 4.4 delivery_address JSON 字段结构

```json
{
  "address": "123 Haight St",
  "city": "San Francisco",
  "state": "CA",
  "zipCode": "94117",
  "phone": "14155551234"
}
```

---

## 5. 订单详情表 (mcs_order_item)

### 5.1 表结构

```sql
CREATE TABLE `mcs_order_item` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '详情ID',
  `order_id` BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
  `coffee_id` BIGINT UNSIGNED NOT NULL COMMENT '咖啡ID',
  `coffee_name` VARCHAR(64) NOT NULL COMMENT '咖啡名称（冗余）',
  `image_url` VARCHAR(255) NOT NULL COMMENT '咖啡图片（冗余）',
  `quantity` INT UNSIGNED NOT NULL COMMENT '数量',
  `price` DECIMAL(10,2) NOT NULL COMMENT '单价（下单时快照）',
  `subtotal` DECIMAL(10,2) NOT NULL COMMENT '小计',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_coffee_id` (`coffee_id`),
  CONSTRAINT `fk_order_item_order` FOREIGN KEY (`order_id`) REFERENCES `mcs_order` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_order_item_coffee` FOREIGN KEY (`coffee_id`) REFERENCES `mcs_coffee` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单详情表';
```

### 5.2 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | 主键 | id | 主键索引 |
| idx_order_id | 普通 | order_id | 按订单查询 |
| idx_coffee_id | 普通 | coffee_id | 按咖啡统计 |

### 5.3 外键关系

| 外键名 | 本表字段 | 关联表 | 关联字段 | 级联操作 |
|--------|----------|--------|----------|----------|
| fk_order_item_order | order_id | mcs_order | id | CASCADE |
| fk_order_item_coffee | coffee_id | mcs_coffee | id | RESTRICT |

---

## 6. ER 图

```
┌─────────────────┐
│    mcs_user     │
│─────────────────│
│ id (PK)         │◄──────┐
│ username        │       │
│ password        │       │
│ email           │       │
│ phone           │       │
└─────────────────┘       │
                          │
                          │ 1:N
                          │
         ┌────────────────┴────────────────┐
         │                                  │
         ▼                                  ▼
┌─────────────────┐               ┌─────────────────┐
│    mcs_cart     │               │   mcs_order     │
│─────────────────│               │─────────────────│
│ id (PK)         │               │ id (PK)         │──┐
│ user_id (FK)    │               │ user_id (FK)    │  │
│ coffee_id (FK)  │               │ order_no        │  │
│ quantity        │               │ total_amount    │  │
│ price           │               │ order_type      │  │
└─────────────────┘               │ status          │  │
         │                        │ create_time     │  │
         │                        └─────────────────┘  │
         │                                          │ 1:N
         │                                          │
         ▼                                          ▼
┌─────────────────┐                       ┌─────────────────┐
│   mcs_coffee    │                       │ mcs_order_item  │
│─────────────────│                       │─────────────────│
│ id (PK)         │                       │ id (PK)         │
│ name            │                       │ order_id (FK)   │
│ description     │                       │ coffee_id (FK)  │
│ price           │                       │ coffee_name     │
│ category        │                       │ quantity        │
│ image_url       │                       │ price           │
│ stock           │                       │ subtotal        │
│ status          │                       └─────────────────┘
└─────────────────┘
```

---

## 7. 初始化数据

### 7.1 插入测试用户

```sql
-- 密码均为: Coffee123! (BCrypt加密后)
INSERT INTO `mcs_user` (`username`, `password`, `email`, `phone`) VALUES
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', 'admin@mycoffeestore.com', '14155550001'),
('test_user', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', 'test@example.com', '14155550002');
```

### 7.2 插入咖啡分类数据

```sql
INSERT INTO `mcs_coffee` (`name`, `description`, `price`, `original_price`, `category`, `category_name`, `image_url`, `stock`, `status`, `sort_order`) VALUES
-- 意式浓缩系列
('经典美式', '精选阿拉比卡豆，深度烘焙，口感醇厚', 4.50, 5.50, 'espresso', '意式浓缩系列', 'https://cdn.example.com/coffee/americano.jpg', 100, 1, 100),
('卡布奇诺', '浓缩咖啡与丝滑奶泡的完美融合', 5.50, 6.50, 'espresso', '意式浓缩系列', 'https://cdn.example.com/coffee/cappuccino.jpg', 80, 1, 99),
('拿铁', '香浓浓缩咖啡配顺滑牛奶', 5.00, 6.00, 'espresso', '意式浓缩系列', 'https://cdn.example.com/coffee/latte.jpg', 90, 1, 98),
('焦糖玛奇朵', '香草糖浆与焦糖酱的甜蜜邂逅', 6.00, 7.00, 'espresso', '意式浓缩系列', 'https://cdn.example.com/coffee/macchiato.jpg', 70, 1, 97),
('摩卡', '浓缩咖啡与巧克力酱的浓郁组合', 6.50, 7.50, 'espresso', '意式浓缩系列', 'https://cdn.example.com/coffee/mocha.jpg', 60, 1, 96),

-- 手冲系列
('耶加雪菲', '埃塞俄比亚产区，花果香气突出', 6.00, NULL, 'brew', '手冲系列', 'https://cdn.example.com/coffee/yirgacheffe.jpg', 50, 1, 95),
('哥斯达黎加', '平衡酸甜，巧克力尾韵', 5.50, NULL, 'brew', '手冲系列', 'https://cdn.example.com/coffee/costarica.jpg', 45, 1, 94),
('肯尼亚AA', '明亮果酸，莓果风味', 6.50, NULL, 'brew', '手冲系列', 'https://cdn.example.com/coffee/kenya.jpg', 40, 1, 93),

-- 冷萃/冰咖啡
('冷萃咖啡', '12小时低温萃取，口感顺滑', 5.50, 6.50, 'cold', '冷萃/冰咖啡', 'https://cdn.example.com/coffee/coldbrew.jpg', 30, 1, 92),
('冰美式', '经典美式加冰，清爽提神', 4.50, 5.50, 'cold', '冷萃/冰咖啡', 'https://cdn.example.com/coffee/icedamericano.jpg', 80, 1, 91),
('氮气冷萃', '注入氮气，如丝般顺滑口感', 7.00, 8.00, 'cold', '冷萃/冰咖啡', 'https://cdn.example.com/coffee/nitro.jpg', 25, 1, 90);
```

---

## 8. 数据库优化建议

### 8.1 分区策略

```sql
-- 订单表按月分区（可选，当数据量达到百万级时考虑）
ALTER TABLE `mcs_order` PARTITION BY RANGE (TO_DAYS(create_time)) (
  PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
  PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
  PARTITION p202403 VALUES LESS THAN (TO_DAYS('2024-04-01')),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 8.2 读写分离

- 主库：处理所有写操作
- 从库：处理所有读操作
- 使用 MyBatis-Flex 的多数据源配置实现

### 8.3 缓存策略

| 数据类型 | 缓存方案 | TTL |
|----------|----------|-----|
| 咖啡列表 | Redis | 5分钟 |
| 咖啡详情 | Redis | 30分钟 |
| 购物车 | Redis | 1小时 |
| 用户信息 | Redis | 30分钟 |
| 订单状态 | Redis | 实时更新 |

---

## 9. 备份策略

### 9.1 全量备份

```bash
# 每天凌晨 2 点执行
mysqldump -u root -p --single-transaction --routines --triggers \
  --databases mycoffeestore > /backup/mycoffeestore_$(date +%Y%m%d).sql
```

### 9.2 增量备份

```bash
# 启用 binlog
# my.cnf 配置:
# log-bin=mysql-bin
# binlog_format=ROW
# expire_logs_days=7
```

---

*文档创建时间：2024-02-26*
*文档版本：v1.0*
